<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ä¸€å¹´çº§å‡æ³•è®­ç»ƒï¼ˆV9 - æ•°å½¢è”ç»“ï¼‰</title>
<style>
:root{
  --bg1:#f9fff4; --bg2:#e7ffe2; --accent:#2e8a3b; --gridAccent:#ffa94d;
  --card:#b9f2b2;
}
body{
  font-family:"Comic Sans MS",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  margin:0;padding:0;display:flex;flex-direction:column;align-items:center;min-height:100vh;box-sizing:border-box;
}
h1{margin:14px 0;color:var(--accent);text-shadow:1px 1px 0 #fff;}
.panel{width:100%;max-width:780px;padding:12px;box-sizing:border-box;text-align:center;}
button{
  background:var(--card);border:none;border-radius:12px;padding:10px 18px;margin:6px;
  font-size:1.02em;cursor:pointer;box-shadow:2px 3px 0 #89c785;
}
button:hover{transform:scale(1.03);}
hr{width:86%;border:none;height:1px;background:#d1f0d3;margin:12px auto;}
#modeSelect h3{margin:10px 0 6px;color:var(--accent);}

/* controls */
.chk{display:flex;flex-direction:column;align-items:center;background:#f2fff5;padding:6px 8px;border-radius:8px;}
.chk input{transform:scale(1.15);margin-bottom:6px;}
input[type="number"]{width:120px;padding:6px;font-size:1em;border-radius:6px;border:2px solid #a4dca2;text-align:center;}

/* game area */
#game{display:none;width:100%;max-width:780px;text-align:center;margin-top:8px;padding-bottom:26px;}
#topBar{display:flex;justify-content:space-between;align-items:center;gap:10px;}
#returnBtn{background:#e2ffd9;box-shadow:2px 3px 0 #a4d3a0;padding:8px 12px;border-radius:10px;}
#modeTag{font-size:0.95em;color:#666;}
#stats{margin-top:8px;color:#444;font-size:1em;}

/* grid (structure) */
/* keep area always occupying vertical space to avoid layout jumps */
#gridHint{
  margin-top:12px;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:8px;
  min-height:150px;        /* fixed space so question doesn't jump */
  visibility:hidden;      /* use visibility so it still occupies space */
}
.gridBox{
  display:grid;grid-template-columns:repeat(5,50px);grid-template-rows:repeat(2,50px);gap:8px;
}
.gridCell{
  width:50px;height:50px;border-radius:8px;background:#fff4e1;border:2px solid #ffd2a0;transition:transform .15s,opacity .15s;
}
.gridCell.filled{background:var(--gridAccent);border-color:#ff8f1f;transform:scale(1.04);}
.gridCell.flash{ animation:flashAnim .6s infinite; }
@keyframes flashAnim{ 0%{opacity:1;}50%{opacity:0.12;}100%{opacity:1;} }

#gridNumberLabel{font-size:1.9em;color:#ff7a00;font-weight:700;text-shadow:1px 1px 0 #fff;}

/* question & input */
#question{margin-top:10px;font-size:2em;color:var(--accent);}
#answerBox{margin-top:10px;}
#answerInput{
  width:110px;height:60px;font-size:2em;text-align:center;border:3px solid #a2dca0;border-radius:12px;outline:none;background:#fafffa;box-shadow:2px 2px 0 #c8ecc8;cursor:pointer;
}
#keypad{display:none;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:12px;}
.keybtn{background:#c3f3b8;border:none;border-radius:10px;width:70px;height:70px;font-size:1.6em;box-shadow:2px 2px 0 #9ed79c;cursor:pointer;}
.keybtn:hover{transform:scale(1.04);}
.wide{width:150px;}

/* wrong list */
#wrongList{margin-top:14px;color:#555;}
#wrongList span{display:inline-block;background:#fff9c4;color:#5c4a00;padding:6px 10px;border-radius:8px;margin:6px;cursor:pointer;box-shadow:1px 1px 3px rgba(0,0,0,0.08);}

/* feedback box */
.feedbackBox{
  position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);padding:12px 18px;border-radius:12px;font-size:1.1em;color:#fff;z-index:999;box-shadow:0 6px 18px rgba(0,0,0,0.15);
}
.feedback-correct{background:linear-gradient(90deg,#61d37a,#3bb34f);}
.feedback-wrong{background:linear-gradient(90deg,#ff8a5c,#ff5b2b);}

/* notify (entry only) */
.notifyBox{
  position:fixed;top:44%;left:50%;transform:translate(-50%,-50%);background:#fff6e0;padding:14px 20px;border-radius:12px;color:#ff7a00;box-shadow:0 0 18px rgba(255,200,120,0.4);z-index:999;font-size:1em;animation:popin .35s ease-out;
}
@keyframes popin{0%{transform:translate(-50%,-50%) scale(0.2);opacity:0;}80%{transform:translate(-50%,-50%) scale(1.05);opacity:1;}100%{transform:translate(-50%,-50%) scale(1);opacity:1;}}

/* small screens */
@media (max-width:420px){
  .gridBox{grid-template-columns:repeat(5,40px);grid-template-rows:repeat(2,40px);gap:6px;}
  .gridCell{width:40px;height:40px;}
  .keybtn{width:60px;height:60px;}
  #answerInput{width:84px;height:52px;font-size:1.6em;}
}
</style>
</head>
<body>

<h1>ä¸€å¹´çº§å‡æ³•è®­ç»ƒï¼ˆV9ï¼‰</h1>

<!-- é¦–é¡µ -->
<div id="modeSelect" class="panel">
  <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:8px;">
    <button onclick="enterOrdinary()">æ™®é€šæ¨¡å¼ï¼ˆé”™äº†æ‰æ˜¾ç¤ºæ ¼å­ï¼‰</button>
    <button onclick="enterMixedMode()">æ··åˆè®­ç»ƒï¼ˆ1â€“9ï¼Œæ— é—ªç°ï¼‰</button>
  </div>

  <hr/>

  <h3>ğŸ§  æ™ºèƒ½ä¸“é¡¹è®­ç»ƒï¼ˆå¯å¤šé€‰ï¼Œé—ªç°é€’å‡ï¼‰</h3>
  <div id="specialChoices" style="display:flex;justify-content:center;gap:10px;flex-wrap:wrap;">
    <label class="chk"><input type="checkbox" value="5">5</label>
    <label class="chk"><input type="checkbox" value="6">6</label>
    <label class="chk"><input type="checkbox" value="7">7</label>
    <label class="chk"><input type="checkbox" value="8">8</label>
    <label class="chk"><input type="checkbox" value="9" checked>9</label>
  </div>

  <div style="margin-top:10px;">
    åˆå§‹é—ªç°æ—¶é—´ï¼ˆæ¯«ç§’ï¼Œå»ºè®® >=300ï¼‰ï¼š <input id="flashTimeInput" type="number" min="300" max="5000" value="1000">
  </div>

  <div style="margin-top:12px;">
    <button onclick="enterSmartMode()">å¼€å§‹æ™ºèƒ½ä¸“é¡¹è®­ç»ƒï¼ˆé—ªç°é€’å‡ï¼‰</button>
  </div>

  <p style="color:#666;margin-top:8px;">ä¸“é¡¹è®­ç»ƒç”¨äºå¼ºåŒ–æŸä¸ªæ•°çš„å‡æ³•ï¼ˆä¾‹å¦‚ 9 çš„å‡æ³•ï¼‰ã€‚æ··åˆè®­ç»ƒä¸º 1â€“9 å…¨é¢ç»ƒä¹ ä¸”æ— é—ªç°ã€‚</p>
</div>

<!-- æ¸¸æˆåŒº -->
<div id="game" class="panel" style="display:none;">
  <div id="topBar" style="display:flex;justify-content:space-between;align-items:center;">
    <div id="modeTag">æ¨¡å¼</div>
    <div>
      <button id="returnBtn" onclick="returnHome()">ğŸ  è¿”å›é¦–é¡µ</button>
    </div>
  </div>

  <div id="stats">ç­”å¯¹: 0 | é”™è¯¯: 0 | è¿å¯¹: 0</div>

  <!-- æ ¼å­ï¼ˆå§‹ç»ˆå ä½ï¼Œä½¿ç”¨ visibility æ§åˆ¶å¯è§æ€§ï¼‰ -->
  <div id="gridHint" style="display:flex;flex-direction:column;align-items:center;">
    <div class="gridBox" id="gridBox"></div>
    <div id="gridNumberLabel" style="margin-top:6px;font-size:1.6em;color:#ff7a00;font-weight:700;"></div>
  </div>

  <div id="question" style="margin-top:12px;font-size:2em;color:var(--accent);"></div>

  <div id="answerBox">
    <input id="answerInput" readonly placeholder="?" onclick="toggleKeypad()">
  </div>

  <div id="keypad" style="display:none;">
    <div style="display:flex;justify-content:center;gap:8px;margin-top:12px;">
      <button class="keybtn" onclick="pressKey(0)">0</button>
      <button class="keybtn" onclick="pressKey(1)">1</button>
      <button class="keybtn" onclick="pressKey(2)">2</button>
      <button class="keybtn" onclick="pressKey(3)">3</button>
      <button class="keybtn" onclick="pressKey(4)">4</button>
      <button class="keybtn" onclick="pressKey(5)">5</button>
    </div>
    <div style="display:flex;justify-content:center;gap:8px;margin-top:8px;">
      <button class="keybtn" onclick="pressKey(6)">6</button>
      <button class="keybtn" onclick="pressKey(7)">7</button>
      <button class="keybtn" onclick="pressKey(8)">8</button>
      <button class="keybtn" onclick="pressKey(9)">9</button>
      <button class="keybtn" onclick="pressKey(10)">10</button>
    </div>
    <div style="display:flex;justify-content:center;gap:12px;margin-top:12px;">
      <button class="keybtn wide" onclick="submitAnswer()">ç¡®å®š âœ…</button>
      <button class="keybtn wide" onclick="clearInput()">æ¸…é™¤ â†º</button>
    </div>
  </div>

  <div id="wrongList" style="margin-top:14px;"></div>
</div>

<script>
/* -------------------
   å…¨å±€çŠ¶æ€
   ------------------- */
let mode = 'idle'; // 'ordinary' | 'smart' | 'mixed'
let specialSet = [];
let baseFlash = 1000; // initial flash (ms)
let flashTime = 1000; // current flash time in smart mode
let correctCount = 0, wrongCount = 0, correctStreak = 0;
let currentA = 0, currentB = 0;
let questionAnsweredWrong = false;
let wrongQuestions = []; // store as "A-B"
let lastFlashInterval = null;

/* -------------------
   åé¦ˆå±•ç¤ºï¼ˆçŸ­æš‚ï¼‰
   ------------------- */
function showFeedback(text, ok=true){
  const box = document.createElement('div');
  box.className = 'feedbackBox ' + (ok ? 'feedback-correct' : 'feedback-wrong');
  box.innerText = text;
  document.body.appendChild(box);
  setTimeout(() => { box.style.transition = 'opacity 0.25s'; box.style.opacity = '0'; setTimeout(()=>box.remove(), 300); }, 800);
}

/* -------------------
   æ¨¡å¼å…¥å£
   ------------------- */
function enterOrdinary(){
  mode = 'ordinary';
  startGame('æ™®é€šæ¨¡å¼ï¼ˆé”™äº†æ‰æ˜¾ç¤ºæ ¼å­ï¼‰');
}
function enterMixedMode(){
  mode = 'mixed';
  startGame('æ··åˆè®­ç»ƒï¼ˆ1â€“9ï¼Œæ— é—ªç°ï¼‰');
}
function enterSmartMode(){
  const boxes = Array.from(document.querySelectorAll('#specialChoices input[type=checkbox]'));
  const sel = boxes.filter(b => b.checked).map(b => parseInt(b.value));
  if(sel.length === 0){ alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä¸“é¡¹æ•°å­—ï¼ˆ5-9 ç­‰ï¼‰'); return; }
  specialSet = sel;
  baseFlash = parseInt(document.getElementById('flashTimeInput').value, 10) || 1000;
  if(baseFlash < 300) baseFlash = 300;
  flashTime = baseFlash;
  correctStreak = 0;
  mode = 'smart';
  // small entry notify (no time details)
  const entry = document.createElement('div');
  entry.className = 'notifyBox'; entry.innerText = 'è¿›å…¥æ™ºèƒ½ä¸“é¡¹è®­ç»ƒï¼š' + sel.join(',') + 'ï¼ˆå¼€å§‹ï¼‰';
  document.body.appendChild(entry);
  setTimeout(()=>{ entry.style.transition='opacity 0.3s'; entry.style.opacity=0; setTimeout(()=>entry.remove(),400); },1200);
  startGame('æ™ºèƒ½ä¸“é¡¹è®­ç»ƒï¼ˆ' + sel.join(',') + 'ï¼‰');
}

/* -------------------
   å¯åŠ¨/è¿”å›
   ------------------- */
function startGame(tag){
  // reset stats & lists
  correctCount = 0; wrongCount = 0; correctStreak = 0;
  wrongQuestions = [];
  updateWrongList();
  updateStatsDisplay();

  document.getElementById('modeSelect').style.display = 'none';
  document.getElementById('game').style.display = 'block';
  document.getElementById('modeTag').innerText = tag;

  nextQuestion();
}
function returnHome(){
  stopAllFlash();
  document.getElementById('game').style.display = 'none';
  document.getElementById('modeSelect').style.display = 'block';
}

/* -------------------
   å‡ºé¢˜é€»è¾‘ï¼ˆA>=1,B>=0,B<Aï¼‰
   ------------------- */
function nextQuestion(){
  // clear previous flash & UI
  stopAllFlash();
  hideGrid();
  clearInput();
  questionAnsweredWrong = false;

  if(mode === 'ordinary'){
    currentA = randInt(2,9);
    currentB = (Math.random() < 0.05) ? 0 : randInt(0, currentA - 1);
  } else if(mode === 'mixed'){
    currentA = randInt(1,9);
    currentB = randInt(0, currentA - 1);
  } else if(mode === 'smart'){
    currentA = specialSet[Math.floor(Math.random() * specialSet.length)];
    currentB = randInt(1, Math.max(1, currentA - 1)); // prefer non-zero for practice
    // show flash according to flashTime (use visibility)
    if(flashTime > 0){
      showGrid(currentA, true);
      setTimeout(()=>{ hideGrid(); }, flashTime);
    }
  } else {
    return;
  }

  document.getElementById('question').innerText = `${currentA} - ${currentB} = ?`;
  updateStatsDisplay();
}

/* -------------------
   æ˜¾ç¤ºç»“æ„åŒ–æ ¼å­ï¼ˆä¸Š5ä¸‹ä½™æ•°ï¼‰
   showLabel: whether show big number label beneath grid (used during flash)
   ------------------- */
function showGrid(a, showLabel){
  const box = document.getElementById('gridBox');
  box.innerHTML = '';
  for(let i=0;i<10;i++){
    const d = document.createElement('div');
    d.className = 'gridCell';
    if(i < a) d.classList.add('filled');
    box.appendChild(d);
  }
  document.getElementById('gridNumberLabel').innerText = showLabel ? a : '';
  // use visibility so area keeps its height
  document.getElementById('gridHint').style.visibility = 'visible';
}

/* hide grid */
function hideGrid(){
  // hide but keep space
  document.getElementById('gridHint').style.visibility = 'hidden';
  document.getElementById('gridBox').innerHTML = '';
  document.getElementById('gridNumberLabel').innerText = '';
}

/* -------------------
   é”™è¯¯æ—¶ï¼šæ˜¾ç¤ºè¢«å‡æ•° A çš„æ ¼å­ï¼Œå¹¶è®©â€œè¢«å‰ªæ‰çš„ B ä¸ªæ ¼å­â€é—ªçƒ
   New rule:
     - if b < 5: flash from LAST filled cell backwards (a-1, a-2, ...)
     - if b >=5: flash from first filled cell forwards (0,1,2...)
   ------------------- */
function showGridWithRemovedFlash(a, b){
  stopAllFlash(); // ensure previous cleared
  const box = document.getElementById('gridBox');
  box.innerHTML = '';
  const cells = [];
  for(let i=0;i<10;i++){
    const d = document.createElement('div');
    d.className = 'gridCell';
    if(i < a) d.classList.add('filled');
    box.appendChild(d);
    cells.push(d);
  }
  document.getElementById('gridNumberLabel').innerText = a;
  document.getElementById('gridHint').style.visibility = 'visible';

  // determine removed indices per new rule
  const removedIndices = [];
  if(b < 5){
    // last b filled cells: indices a-1 down to a-b
    for(let i = a - 1; i >= a - b; i--){
      if(i >= 0) removedIndices.push(i);
    }
  } else {
    // first b filled cells: indices 0..b-1 (but limited by a)
    for(let i = 0; i < b && i < a; i++){
      removedIndices.push(i);
    }
  }

  // apply flash class to removed cells
  removedIndices.forEach(idx => {
    if(cells[idx]) cells[idx].classList.add('flash');
  });

  // keep a small interval handle so we can clear later
  lastFlashInterval = setInterval(()=>{}, 1000);
}

/* stop flashing & clear interval */
function stopAllFlash(){
  if(lastFlashInterval){
    clearInterval(lastFlashInterval);
    lastFlashInterval = null;
  }
  const f = document.querySelectorAll('.gridCell.flash');
  f.forEach(n => n.classList.remove('flash'));
}

/* -------------------
   ç­”æ¡ˆæäº¤ä¸å¤„ç†
   ------------------- */
function pressKey(n){ document.getElementById('answerInput').value = String(n); }
function clearInput(){ document.getElementById('answerInput').value = ''; }
function toggleKeypad(){ const pad = document.getElementById('keypad'); pad.style.display = pad.style.display === 'flex' ? 'none' : 'flex'; }
function hideKeypad(){ document.getElementById('keypad').style.display = 'none'; }

function submitAnswer(){
  const val = document.getElementById('answerInput').value.trim();
  if(val === ''){ alert('è¯·å…ˆè¾“å…¥ç­”æ¡ˆ'); return; }
  const choice = parseInt(val, 10);
  const correct = currentA - currentB;
  if(choice === correct){
    correctCount++;
    correctStreak++;
    showFeedback('ç­”å¯¹å•¦ï¼', true);
    showStar();
    if(mode === 'smart') adjustFlashOnCorrect();
    setTimeout(()=>{ nextQuestion(); }, 700);
  } else {
    if(!questionAnsweredWrong){
      wrongCount++;
      questionAnsweredWrong = true;
      wrongQuestions.unshift(`${currentA}-${currentB}`);
      if(wrongQuestions.length > 5) wrongQuestions.pop();
      updateWrongList();
    }
    correctStreak = 0;
    if(mode === 'smart') adjustFlashOnWrong();
    showGridWithRemovedFlash(currentA, currentB);
    playVoice(currentB, currentA - currentB);
    showFeedback('å†æƒ³æƒ³~', false);
  }
  updateStatsDisplay();
}

/* -------------------
   Smart flash adjust logic (no time-notify)
   ------------------- */
function adjustFlashOnCorrect(){
  if(correctStreak === 5 && flashTime > Math.round(baseFlash * 0.6)){
    flashTime = Math.round(baseFlash * 0.6);
  } else if(correctStreak === 10 && flashTime > Math.round(baseFlash * 0.3)){
    flashTime = Math.round(baseFlash * 0.3);
  } else if(correctStreak === 15 && flashTime > 0){
    flashTime = 0;
  }
}
function adjustFlashOnWrong(){
  if(flashTime === 0){
    flashTime = Math.round(baseFlash * 0.3);
  } else if(flashTime <= Math.round(baseFlash * 0.3)){
    flashTime = Math.round(baseFlash * 0.6);
  } else if(flashTime <= Math.round(baseFlash * 0.6)){
    flashTime = baseFlash;
  }
}

/* -------------------
   Wrong list & retry
   ------------------- */
function updateWrongList(){
  const box = document.getElementById('wrongList');
  if(wrongQuestions.length === 0){ box.innerHTML = ''; return; }
  box.innerHTML = 'é”™é¢˜å›é¡¾ï¼š' + wrongQuestions.map((q, i) => `<span onclick="retryWrong(${i})">${q}</span>`).join('');
}
function retryWrong(i){
  const q = wrongQuestions[i];
  if(!q) return;
  const parts = q.split('-').map(x=>parseInt(x,10));
  currentA = parts[0]; currentB = parts[1];
  stopAllFlash(); clearInput();
  document.getElementById('question').innerText = `${currentA} - ${currentB} = ? (å¤ä¹ é¢˜)`;
  showGrid(currentA, true);
  questionAnsweredWrong = false;
}

/* -------------------
   Utilities & UI helpers
   ------------------- */
function updateStatsDisplay(){
  document.getElementById('stats').innerText = `ç­”å¯¹: ${correctCount} | é”™è¯¯: ${wrongCount} | è¿å¯¹: ${correctStreak}`;
}
function notifyEntry(msg){
  const n = document.createElement('div'); n.className = 'notifyBox'; n.innerText = msg;
  document.body.appendChild(n);
  setTimeout(()=>{ n.style.transition = 'opacity 0.45s'; n.style.opacity = '0'; setTimeout(()=>n.remove(),500); }, 1400);
}
function showStar(){
  const s = document.createElement('div'); s.className = 'star'; s.innerText = 'â­';
  document.body.appendChild(s); setTimeout(()=>s.remove(), 900);
}
function randInt(min, max){ return Math.floor(Math.random() * (max - min + 1)) + min; }

/* -------------------
   Speech (è¯­éŸ³æç¤º)
   ------------------- */
function playVoice(removed, remain){
  try {
    const text = `å‰ªæ‰ ${removed} ä¸ªï¼Œè¿˜å‰© ${remain} ä¸ª`;
    const msg = new SpeechSynthesisUtterance(text);
    msg.lang = 'zh-CN';
    msg.rate = 0.95;
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(msg);
  } catch(e){ console.warn('speech failed', e); }
}

/* -------------------
   Keypad handlers & keyboard
   ------------------- */
function pressKey(n){ document.getElementById('answerInput').value = String(n); }
function clearInput(){ document.getElementById('answerInput').value = ''; }
function toggleKeypad(){ const pad = document.getElementById('keypad'); pad.style.display = pad.style.display === 'flex' ? 'none' : 'flex'; }
function hideKeypad(){ document.getElementById('keypad').style.display = 'none'; }
document.addEventListener('keydown', (e) => { if(e.key === 'Enter') submitAnswer(); });

/* -------------------
   End
   ------------------- */
</script>
</body>
</html>
