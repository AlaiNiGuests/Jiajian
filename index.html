<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ä¸€å¹´çº§å‡æ³•è®­ç»ƒï¼ˆå¯è°ƒé—ªç°æ—¶é—´ï¼‰</title>
<style>
:root{
  --bg1:#f9fff4;
  --bg2:#e7ffe2;
  --accent:#44aa55;
  --gridColor:#ffa94d;
}
body{
  font-family:"Comic Sans MS",sans-serif;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  margin:0;padding:0;
  display:flex;flex-direction:column;align-items:center;
  min-height:100vh;box-sizing:border-box;
}
h1{margin-top:14px;color:var(--accent);text-shadow:1px 1px 0 #fff;}
.panel{width:100%;max-width:760px;padding:12px;text-align:center;box-sizing:border-box;}
button{
  background:#b9f2b2;border:none;border-radius:12px;padding:10px 18px;margin:6px;
  font-size:1.05em;cursor:pointer;box-shadow:2px 3px 0 #8cc78a;
}
button:hover{transform:scale(1.03);}
hr{width:86%;border:none;height:1px;background:#d1f0d3;margin:12px auto;}
#modeSelect h3{margin:8px 0 6px;color:#2e8a3b;}
#specialChoices{display:flex;justify-content:center;gap:10px;margin:8px 0;flex-wrap:wrap;}
.chk{display:flex;flex-direction:column;align-items:center;background:#f2fff5;padding:6px 8px;border-radius:8px;}
.chk input{transform:scale(1.2);margin-bottom:6px;}
input[type="number"]{width:120px;padding:6px;font-size:1em;border-radius:6px;border:2px solid #a4dca2;text-align:center;}

/* game */
#game{display:none;width:100%;max-width:760px;text-align:center;margin-top:8px;}
#topBar{display:flex;justify-content:space-between;align-items:center;gap:10px;}
#returnBtn{background:#e2ffd9;box-shadow:2px 3px 0 #a4d3a0;padding:8px 12px;border-radius:10px;}
#question{font-size:2em;color:var(--accent);margin:12px 0;}
/* grid */
#gridHint{display:none;flex-direction:column;align-items:center;justify-content:center;gap:6px;margin-top:10px;}
.gridBox{
  display:grid;
  grid-template-columns:repeat(5,52px);
  grid-template-rows:repeat(2,52px);
  gap:8px;
}
.gridCell{
  width:52px;height:52px;
  border-radius:8px;
  background:#fff4e1;
  border:2px solid #ffd2a0;
  transition:transform .2s,background .2s;
}
.gridCell.filled{
  background:var(--gridColor);
  border-color:#ff8f1f;
  transform:scale(1.05);
  animation:flashPop .3s ease-out;
}
@keyframes flashPop{
  0%{transform:scale(0.4);opacity:0.3;}
  80%{transform:scale(1.08);opacity:1;}
  100%{transform:scale(1);}
}
#gridNumberLabel{
  font-size:2em;
  color:#ff8800;
  font-weight:bold;
  text-shadow:1px 1px 0 #fff;
}
/* input area */
#answerBox{margin-top:12px;}
#answerInput{
  width:100px;height:60px;font-size:2em;text-align:center;
  border:3px solid #a2dca0;border-radius:12px;outline:none;
  background:#fafffa;box-shadow:2px 2px 0 #c8ecc8;cursor:pointer;
}
#keypad{display:none;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:12px;}
.keybtn{background:#c3f3b8;border:none;border-radius:10px;width:70px;height:70px;font-size:1.6em;box-shadow:2px 2px 0 #9ed79c;cursor:pointer;}
.keybtn:hover{transform:scale(1.05);}
.wide{width:150px;}
#stats{margin-top:12px;color:#444;}
#wrongList{margin-top:16px;color:#555;font-size:1em;}
#wrongList span{display:inline-block;background:#fff9c4;color:#5c4a00;padding:6px 10px;border-radius:8px;margin:6px;cursor:pointer;}
.star{position:fixed;font-size:2em;color:gold;animation:starFly 1s ease-out forwards;}
@keyframes starFly{0%{transform:scale(0);opacity:1;top:50%;left:50%}100%{transform:scale(1.8) translateY(-200px);opacity:0}}
.notifyBox{position:fixed;top:45%;left:50%;transform:translate(-50%,-50%);background:#fff6e0;padding:18px 26px;border-radius:14px;font-size:1.05em;color:#ff7a00;box-shadow:0 0 15px rgba(255,200,120,0.6);animation:popin .35s ease-out;}
@keyframes popin{0%{transform:translate(-50%,-50%) scale(0.2);opacity:0;}80%{transform:translate(-50%,-50%) scale(1.05);opacity:1;}100%{transform:translate(-50%,-50%) scale(1);}}
</style>
</head>
<body>
<h1>ä¸€å¹´çº§å‡æ³•è®­ç»ƒ</h1>

<!-- æ¨¡å¼é€‰æ‹© -->
<div id="modeSelect" class="panel">
  <button onclick="enterOrdinary()">æ™®é€šæ¨¡å¼ï¼ˆé”™äº†æ‰æ˜¾ç¤ºæ ¼å­ï¼‰</button>
  <button onclick="enterMixedMode()">æ··åˆè®­ç»ƒï¼ˆ1â€“9ï¼Œæ— é—ªç°ï¼‰</button>
  <hr>
  <h3>ğŸ§  ä¸“é¡¹è®­ç»ƒï¼ˆæ™ºèƒ½é—ªç°é€’å‡ï¼‰</h3>
  <div id="specialChoices">
    <label class="chk"><input type="checkbox" value="5">5</label>
    <label class="chk"><input type="checkbox" value="6">6</label>
    <label class="chk"><input type="checkbox" value="7">7</label>
    <label class="chk"><input type="checkbox" value="8">8</label>
    <label class="chk"><input type="checkbox" value="9" checked>9</label>
  </div>
  <div style="margin:10px 0;">
    åˆå§‹é—ªç°æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ï¼š
    <input id="flashTimeInput" type="number" min="300" max="3000" value="1000">
  </div>
  <button onclick="enterSmartMode()">å¼€å§‹æ™ºèƒ½ä¸“é¡¹è®­ç»ƒï¼ˆé—ªç°é€’å‡ï¼‰</button>
</div>

<!-- æ¸¸æˆç•Œé¢ -->
<div id="game" class="panel">
  <div id="topBar">
    <div style="visibility:hidden"></div>
    <div id="modeTag" style="font-size:0.95em;color:#666;"></div>
    <button id="returnBtn" onclick="returnHome()">ğŸ  è¿”å›</button>
  </div>

  <div id="gridHint">
    <div class="gridBox" id="gridBox"></div>
    <div id="gridNumberLabel"></div>
  </div>

  <div id="question"></div>

  <div id="answerBox">
    <input id="answerInput" readonly placeholder="?" onclick="toggleKeypad()">
  </div>

  <div id="keypad">
    <div style="display:flex;justify-content:center;gap:8px;margin-bottom:8px;">
      <button class="keybtn" onclick="pressKey(0)">0</button>
      <button class="keybtn" onclick="pressKey(1)">1</button>
      <button class="keybtn" onclick="pressKey(2)">2</button>
      <button class="keybtn" onclick="pressKey(3)">3</button>
      <button class="keybtn" onclick="pressKey(4)">4</button>
      <button class="keybtn" onclick="pressKey(5)">5</button>
    </div>
    <div style="display:flex;justify-content:center;gap:8px;">
      <button class="keybtn" onclick="pressKey(6)">6</button>
      <button class="keybtn" onclick="pressKey(7)">7</button>
      <button class="keybtn" onclick="pressKey(8)">8</button>
      <button class="keybtn" onclick="pressKey(9)">9</button>
      <button class="keybtn" onclick="pressKey(10)">10</button>
    </div>
    <div style="display:flex;justify-content:center;gap:8px;margin-top:10px;">
      <button class="keybtn wide" onclick="submitAnswer()">ç¡®å®š âœ…</button>
      <button class="keybtn wide" onclick="clearInput()">æ¸…é™¤ â†º</button>
    </div>
  </div>

  <div id="stats"></div>
  <div id="wrongList"></div>
</div>

<script>
let mode='idle',specialSet=[],currentA=0,currentB=0;
let flashTime=0,correctCount=0,wrongCount=0,correctStreak=0,questionAnsweredWrong=false;
let wrongQuestions=[];

/* --- Entry --- */
function enterOrdinary(){mode='ordinary';flashTime=0;startGame('æ™®é€šæ¨¡å¼ï¼ˆé”™äº†æ‰æ˜¾ç¤ºæ ¼å­ï¼‰');}
function enterMixedMode(){mode='mixed';flashTime=0;startGame('æ··åˆè®­ç»ƒï¼ˆ1â€“9ï¼Œæ— é—ªç°ï¼‰');}
function enterSmartMode(){
  const sel=Array.from(document.querySelectorAll('#specialChoices input[type=checkbox]')).filter(b=>b.checked).map(b=>+b.value);
  if(sel.length===0){alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ•°å­—');return;}
  specialSet=sel;
  const base=parseInt(document.getElementById('flashTimeInput').value)||1000;
  flashTime=base;
  correctStreak=0;
  notify('è¿›å…¥æ™ºèƒ½ä¸“é¡¹è®­ç»ƒï¼š'+sel.join(',')+'ï¼ˆåˆå§‹é—ªç° '+base+'msï¼‰');
  mode='smart';
  startGame('æ™ºèƒ½ä¸“é¡¹è®­ç»ƒï¼ˆ'+sel.join(',')+'ï¼‰');
}

/* --- Game core (same as v6) --- */
function startGame(tag){correctCount=wrongCount=correctStreak=0;wrongQuestions=[];document.getElementById('modeSelect').style.display='none';document.getElementById('game').style.display='block';document.getElementById('modeTag').innerText=tag;nextQuestion();}
function returnHome(){document.getElementById('game').style.display='none';document.getElementById('modeSelect').style.display='block';}

function nextQuestion(){
  hideGridHint();clearInput();hideKeypad();questionAnsweredWrong=false;
  if(mode==='ordinary'){currentA=rand(2,9);currentB=rand(0,currentA-1);}
  else if(mode==='mixed'){currentA=rand(1,9);currentB=rand(0,currentA-1);}
  else if(mode==='smart'){currentA=specialSet[Math.floor(Math.random()*specialSet.length)];currentB=rand(1,Math.max(1,currentA-1));
    if(flashTime>0){showGrid(currentA,true);setTimeout(hideGridHint,flashTime);}
  }
  document.getElementById('question').innerText=`${currentA} - ${currentB} = ?`;
  updateStats();
}

/* grid display */
function showGrid(num,showLabel=false){
  const hint=document.getElementById('gridHint'),box=document.getElementById('gridBox'),lbl=document.getElementById('gridNumberLabel');
  box.innerHTML='';lbl.innerText='';
  for(let i=0;i<10;i++){const d=document.createElement('div');d.className='gridCell';if(i<num)d.classList.add('filled');box.appendChild(d);}
  if(showLabel)lbl.innerText=num;
  hint.style.display='flex';
}
function hideGridHint(){document.getElementById('gridHint').style.display='none';}

/* input */
function pressKey(n){document.getElementById('answerInput').value=String(n);}
function clearInput(){document.getElementById('answerInput').value='';}
function toggleKeypad(){const k=document.getElementById('keypad');k.style.display=k.style.display==='flex'?'none':'flex';}
function hideKeypad(){document.getElementById('keypad').style.display='none';}

function submitAnswer(){
  const val=document.getElementById('answerInput').value.trim();if(!val)return alert('è¯·å…ˆè¾“å…¥ç­”æ¡ˆ');
  const ans=parseInt(val,10),right=currentA-currentB;
  if(ans===right){correctCount++;correctStreak++;showStar();if(mode==='smart')adjustFlashOnCorrect();setTimeout(()=>nextQuestion(),700);}
  else{if(!questionAnsweredWrong){wrongCount++;questionAnsweredWrong=true;wrongQuestions.unshift(`${currentA}-${currentB}`);if(wrongQuestions.length>5)wrongQuestions.pop();updateWrongList();}
    correctStreak=0;if(mode==='smart')adjustFlashOnWrong();showGrid(currentA,true);}
  updateStats();
}

/* smart flash logic */
function adjustFlashOnCorrect(){
  const base=parseInt(document.getElementById('flashTimeInput').value)||1000;
  if(correctStreak===5&&flashTime>base*0.6){flashTime=base*0.6;notify('ğŸ‘ é—ªç°ç¼©çŸ­ä¸º '+Math.round(flashTime)+'ms');}
  else if(correctStreak===10&&flashTime>base*0.3){flashTime=base*0.3;notify('ğŸŒŸ é—ªç°ç¼©çŸ­ä¸º '+Math.round(flashTime)+'ms');}
  else if(correctStreak===15&&flashTime>0){flashTime=0;notify('ğŸ‰ è¿›å…¥æ— é—ªç°é˜¶æ®µï¼');}
}
function adjustFlashOnWrong(){
  const base=parseInt(document.getElementById('flashTimeInput').value)||1000;
  if(flashTime===0){flashTime=base*0.3;notify('âš ï¸ å›é€€è‡³ '+Math.round(flashTime)+'ms');}
  else if(flashTime<=base*0.3){flashTime=base*0.6;notify('âš ï¸ å›é€€è‡³ '+Math.round(flashTime)+'ms');}
  else if(flashTime<=base*0.6){flashTime=base;notify('âš ï¸ å›é€€è‡³ '+base+'ms');}
}

/* misc */
function updateStats(){document.getElementById('stats').innerText=`ç­”å¯¹:${correctCount} | é”™è¯¯:${wrongCount} | è¿å¯¹:${correctStreak}`;}
function updateWrongList(){const b=document.getElementById('wrongList');if(wrongQuestions.length===0){b.innerHTML='';return;}b.innerHTML='é”™é¢˜å›é¡¾ï¼š'+wrongQuestions.map((q,i)=>`<span onclick="retry(${i})">${q}</span>`).join('');}
function retry(i){const q=wrongQuestions[i];if(!q)return;const[a,b]=q.split('-').map(x=>+x);currentA=a;currentB=b;document.getElementById('question').innerText=`${a} - ${b} = ? (å¤ä¹ é¢˜)`;showGrid(a,true);questionAnsweredWrong=false;clearInput();}
function notify(msg){const n=document.createElement('div');n.className='notifyBox';n.innerText=msg;document.body.appendChild(n);setTimeout(()=>{n.style.opacity='0';setTimeout(()=>n.remove(),500);},1800);}
function showStar(){const s=document.createElement('div');s.className='star';s.innerText='â­';document.body.appendChild(s);setTimeout(()=>s.remove(),900);}
function rand(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
</script>
</body>
</html>
